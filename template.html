<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caddy Traffic Dashboard</title>
    <style>
        /* --- 1. Core Variables (From your provided style) --- */
        :root {
            /* Light Mode */
            --bg-color: #ffffff;
            --text-color: #111111;
            --accent-color: #666666;
            --meta-color: #888888;
            
            /* Glass Effect */
            --glass-overlay: rgba(255, 255, 255, 0.4);
            --card-bg: rgba(255, 255, 255, 0.65);
            --card-border: rgba(255, 255, 255, 0.4);
            --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
            
            /* Orbs */
            --orb-color-1: rgba(0, 0, 0, 0.08);
            --orb-color-2: rgba(0, 0, 0, 0.05);
            
            /* Animations */
            --transition-speed: 0.6s;
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            
            /* Fonts */
            --font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Inter', "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --spacing-unit: 1.5rem;

            /* --- Data Visualization Palette (New) --- */
            /* Status Code Colors (Semantic) */
            --color-2xx: #10b981; /* Emerald */
            --color-3xx: #3b82f6; /* Blue */
            --color-4xx: #f59e0b; /* Amber */
            --color-5xx: #ef4444; /* Red */
            --color-other: #9ca3af; /* Gray */

            /* Dynamic Palette (For general data) */
            --palette-1: #6366f1; /* Indigo */
            --palette-2: #8b5cf6; /* Violet */
            --palette-3: #ec4899; /* Pink */
            --palette-4: #06b6d4; /* Cyan */
            --palette-5: #f97316; /* Orange */
            --palette-6: #14b8a6; /* Teal */
            --palette-7: #f43f5e; /* Rose */
            --palette-8: #3b82f6; /* Blue */
        }

        /* Dark Mode */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #0a0a0a;
                --text-color: #ffffff;
                --accent-color: #a1a1a1;
                --meta-color: #888888;
                
                --glass-overlay: rgba(0, 0, 0, 0.2);
                --card-bg: rgba(20, 20, 20, 0.6);
                --card-border: rgba(255, 255, 255, 0.08);
                --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                
                --orb-color-1: rgba(255, 255, 255, 0.06);
                --orb-color-2: rgba(255, 255, 255, 0.03);

                /* Adjust palette for dark mode contrast if needed */
                --palette-1: #818cf8;
                --palette-2: #a78bfa;
                --palette-3: #f472b6;
                --palette-4: #22d3ee;
                --palette-5: #fb923c;
                --palette-6: #2dd4bf;
                --palette-7: #fb7185;
                --palette-8: #60a5fa;
            }
        }

        /* --- 2. Global Resets & Body --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            transition: background-color 0.8s ease, color 0.8s ease;
            position: relative;
        }

        /* --- 3. Background Animations (Orbs) --- */
        .background-orbs {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: -2; pointer-events: none;
        }
        .orb {
            position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.8;
            animation: float 25s infinite ease-in-out alternate;
        }
        .orb-1 {
            width: 70vw; height: 70vw; background: var(--orb-color-1);
            top: -15%; left: -15%; animation-duration: 35s;
        }
        .orb-2 {
            width: 60vw; height: 60vw; background: var(--orb-color-2);
            bottom: -15%; right: -15%; animation-duration: 45s; animation-delay: -5s;
        }
        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(40px, 60px) scale(1.1); }
            100% { transform: translate(-30px, 20px) scale(0.95); }
        }

        .frosted-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            backdrop-filter: blur(60px) saturate(120%);
            -webkit-backdrop-filter: blur(60px) saturate(120%);
            background: var(--glass-overlay); pointer-events: none;
        }

        /* --- 4. Layout Containers --- */
        main {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            padding: var(--spacing-unit); z-index: 10;
        }

        .content-wrapper {
            width: 100%;
            /* Optimized Width: Increased from 900px to 1400px for better desktop usage */
            max-width: 1400px; 
            display: flex; flex-direction: column; align-items: center;
        }

        header {
            text-align: center; margin-bottom: 3rem; margin-top: 1rem;
            animation: fadeInDown 1s var(--ease-out-expo) forwards;
        }

        .title {
            font-size: 3rem; font-weight: 800; letter-spacing: -0.02em; margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--text-color) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            display: flex; align-items: center; justify-content: center; gap: 1rem; flex-wrap: wrap;
        }

        .subtitle {
            font-size: 1.1rem; color: var(--accent-color); font-weight: 400;
        }

        .badge {
            font-size: 0.8rem; padding: 0.3em 0.8em; border-radius: 100px;
            color: #fff; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase;
            -webkit-text-fill-color: #fff; /* Reset gradient text */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            display: none;
        }
        .badge-global { background: linear-gradient(135deg, #7c3aed, #6d28d9); }
        .badge-instance { background: linear-gradient(135deg, #059669, #047857); }

        /* --- 5. Grid & Cards --- */
        .dynamic-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr); /* 12 column grid for flexibility */
            gap: 1.5rem;
            width: 100%;
        }

        .col-half { grid-column: span 6; }
        .col-full { grid-column: span 12; }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            transition: transform 0.4s var(--ease-out-expo), box-shadow 0.4s var(--ease-out-expo);
            opacity: 0; /* For animation */
            animation: fadeInUp 0.8s var(--ease-out-expo) forwards;
        }

        .card:hover {
            transform: translateY(-4px) scale(1.005);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-color: var(--accent-color);
        }

        /* Metrics Styling */
        .metric-group {
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;
        }
        .metric-value {
            font-size: 4.5rem; font-weight: 800; line-height: 1;
            background: linear-gradient(180deg, var(--text-color) 20%, var(--accent-color) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-variant-numeric: tabular-nums;
            margin-bottom: 0.5rem;
        }
        .metric-label {
            font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.15em;
            color: var(--meta-color); font-weight: 600;
        }

        /* Chart/List Styling */
        .card-title {
            font-size: 1rem; text-transform: uppercase; letter-spacing: 0.1em;
            color: var(--meta-color); margin-bottom: 1.5rem; font-weight: 600; border-bottom: 1px solid var(--card-border);
            padding-bottom: 1rem; display: block;
        }

        .stats-list { display: flex; flex-direction: column; gap: 1.2rem; }
        .stat-item { width: 100%; }
        .stat-header {
            display: flex; justify-content: space-between; margin-bottom: 0.4rem;
            font-size: 0.95rem; font-weight: 500; color: var(--text-color);
        }
        .stat-name { font-family: monospace; opacity: 0.9; }
        
        .progress-track {
            width: 100%; height: 8px; background-color: rgba(0, 0, 0, 0.05);
            border-radius: 4px; overflow: hidden;
            /* Added explicit z-index context */
            position: relative;
            z-index: 1;
        }
        @media (prefers-color-scheme: dark) { .progress-track { background-color: rgba(255, 255, 255, 0.1); } }
        
        .progress-bar {
            height: 100%; border-radius: 4px;
            transition: width 1.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            width: 0%; box-shadow: 0 0 10px rgba(0,0,0,0.1);
            /* Ensure bar is above track background */
            position: relative;
            z-index: 2;
        }

        .empty-state { text-align: center; color: var(--meta-color); padding: 3rem; font-style: italic; opacity: 0.6; }

        /* --- 6. Modern Language Selector (Custom Dropdown) --- */
        .lang-container {
            position: absolute; top: 2rem; right: 2rem; z-index: 100;
        }

        .lang-btn {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-color);
            padding: 0.6rem 1.2rem;
            border-radius: 100px;
            font-family: inherit; font-weight: 600; font-size: 0.9rem;
            cursor: pointer;
            display: flex; align-items: center; gap: 0.5rem;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .lang-btn:hover, .lang-btn.active {
            background: var(--text-color); color: var(--bg-color);
            transform: translateY(-2px);
        }

        .lang-icon { width: 16px; height: 16px; fill: currentColor; }

        .lang-menu {
            position: absolute; top: calc(100% + 10px); right: 0;
            background: var(--card-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 0.5rem;
            min-width: 160px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            opacity: 0; transform: translateY(-10px) scale(0.95);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .lang-menu.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }

        .lang-option {
            display: block; width: 100%; text-align: left;
            padding: 0.6rem 1rem; border: none; background: transparent;
            color: var(--text-color); font-family: inherit; font-size: 0.9rem; font-weight: 500;
            cursor: pointer; border-radius: 10px;
            transition: background 0.2s;
        }

        .lang-option:hover { background: rgba(125, 125, 125, 0.1); }
        .lang-option.selected { color: var(--accent-color); font-weight: 700; }

        /* --- 7. Footer --- */
        footer {
            margin-top: 4rem; text-align: center;
            font-size: 0.85rem; color: var(--meta-color); opacity: 0;
            animation: fadeIn 1s ease forwards 1s;
        }

        /* --- 8. Responsive Design --- */
        @media (max-width: 1024px) {
            .col-half { grid-column: span 12; }
        }

        @media (max-width: 768px) {
            .title { font-size: 2rem; }
            .lang-container { top: 1.5rem; right: 1.5rem; }
            .content-wrapper { padding: 0 1rem; }
            .card { padding: 1.5rem; border-radius: 20px; }
            .metric-value { font-size: 3.5rem; }
        }

        /* Mobile specific adjustments for language selector */
        @media (max-width: 480px) {
            .lang-btn span { display: none; } /* Hide text, show only icon on tiny screens */
            .lang-btn { padding: 0.6rem; border-radius: 50%; }
        }

        /* --- Animations Keyframes --- */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            to { opacity: 0.7; }
        }
    </style>
</head>
<body>

    <!-- Background Effects -->
    <div class="background-orbs">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>
    <div class="frosted-overlay"></div>

    <!-- Language Selector (Modern) -->
    <div class="lang-container">
        <button class="lang-btn" id="langBtn" onclick="toggleLangMenu()">
            <svg class="lang-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
            <span id="currentLangLabel">English</span>
        </button>
        <div class="lang-menu" id="langMenu">
            <button class="lang-option" onclick="selectLanguage('en')">English</button>
            <button class="lang-option" onclick="selectLanguage('zh-CN')">简体中文</button>
            <button class="lang-option" onclick="selectLanguage('zh-TW')">繁體中文</button>
            <button class="lang-option" onclick="selectLanguage('ja')">日本語</button>
        </div>
    </div>

    <main>
        <div class="content-wrapper">
            <header>
                <h1 class="title">
                    <span data-i18n="main_title">Caddy Traffic</span>
                    <span id="scopeBadge" class="badge"></span>
                </h1>
                <p class="subtitle" data-i18n="subtitle">Real-time Monitoring Dashboard</p>
            </header>

            <!-- Dynamic Content Container -->
            <div id="dashboardContent" class="dynamic-grid">
                <!-- Cards will be injected here by JS -->
                <div class="col-full empty-state" id="loadingState">Loading configuration...</div>
            </div>

            <footer data-i18n="footer">Generated by Caddy Traffic Stats Module</footer>
        </div>
    </main>

    <script>
        // --- Translations ---
        const translations = {
            "en": {
                "page_title": "Caddy Traffic Dashboard",
                "main_title": "Caddy Traffic",
                "subtitle": "Real-time Monitoring Dashboard",
                "total_requests": "Total Requests",
                "total_websockets": "WebSocket Connects",
                "transport": "Transport",
                "tls_version": "TLS Version",
                "cipher_suites": "Cipher Suites",
                "curves": "Key Exchange (Curves)",
                "alpn": "ALPN (Negotiated)",
                "hsts_status": "HSTS Status",
                "ip_version": "IP Version",
                "http_protocols": "HTTP Protocols",
                "response_codes": "Response Codes",
                "no_data": "No data",
                "footer": "Generated by Caddy Traffic Stats Module",
                "loading": "Loading..."
            },
            "zh-CN": {
                "page_title": "Caddy 流量监控看板",
                "main_title": "Caddy 流量监控",
                "subtitle": "实时流量监控面板",
                "total_requests": "总请求数",
                "total_websockets": "WebSocket 连接数",
                "transport": "传输层协议",
                "tls_version": "TLS 版本",
                "cipher_suites": "加密套件 (Cipher Suites)",
                "curves": "密钥交换 (Curves)",
                "alpn": "应用层协商 (ALPN)",
                "hsts_status": "HSTS 状态",
                "ip_version": "IP 版本",
                "http_protocols": "HTTP 协议",
                "response_codes": "响应状态码",
                "no_data": "暂无数据",
                "footer": "由 Caddy Traffic Stats 模块生成",
                "loading": "加载中..."
            },
            "zh-TW": {
                "page_title": "Caddy 流量監控看板",
                "main_title": "Caddy 流量監控",
                "subtitle": "即時流量監控面板",
                "total_requests": "總請求數",
                "total_websockets": "WebSocket 連線數",
                "transport": "傳輸層協議",
                "tls_version": "TLS 版本",
                "cipher_suites": "加密套件 (Cipher Suites)",
                "curves": "密鑰交換 (Curves)",
                "alpn": "應用層協商 (ALPN)",
                "hsts_status": "HSTS 狀態",
                "ip_version": "IP 版本",
                "http_protocols": "HTTP 協議",
                "response_codes": "響應狀態碼",
                "no_data": "暫無數據",
                "footer": "由 Caddy Traffic Stats 模組生成",
                "loading": "載入中..."
            },
            "ja": {
                "page_title": "Caddy トラフィック監視",
                "main_title": "Caddy トラフィック",
                "subtitle": "リアルタイム監視ダッシュボード",
                "total_requests": "総リクエスト数",
                "total_websockets": "WebSocket 接続数",
                "transport": "トランスポート層",
                "tls_version": "TLS バージョン",
                "cipher_suites": "暗号スイート",
                "curves": "鍵交換 (Curves)",
                "alpn": "ALPN (交渉済み)",
                "hsts_status": "HSTS ステータス",
                "ip_version": "IP バージョン",
                "http_protocols": "HTTP プロトコル",
                "response_codes": "レスポンスコード",
                "no_data": "データなし",
                "footer": "Caddy Traffic Stats モジュールによって生成",
                "loading": "読み込み中..."
            }
        };

        const langLabels = {
            "en": "English",
            "zh-CN": "简体中文",
            "zh-TW": "繁體中文",
            "ja": "日本語"
        };

        // --- Global State ---
        let currentLang = 'en';
        let dashboardConfig = null;
        let currentStats = null;

        // --- Color Palette System ---
        // Names of CSS variables defined in :root
        const colorPalette = [
            '--palette-1', // Indigo
            '--palette-2', // Violet
            '--palette-3', // Pink
            '--palette-4', // Cyan
            '--palette-5', // Orange
            '--palette-6', // Teal
            '--palette-7', // Rose
            '--palette-8'  // Blue
        ];

        // --- Language UI Logic ---
        function toggleLangMenu() {
            const menu = document.getElementById('langMenu');
            const btn = document.getElementById('langBtn');
            menu.classList.toggle('open');
            btn.classList.toggle('active');
        }

        function selectLanguage(lang) {
            changeLanguage(lang);
            document.getElementById('langMenu').classList.remove('open');
            document.getElementById('langBtn').classList.remove('active');
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const container = document.querySelector('.lang-container');
            if (!container.contains(event.target)) {
                document.getElementById('langMenu').classList.remove('open');
                document.getElementById('langBtn').classList.remove('active');
            }
        });

        // --- Core Logic ---

        async function initDashboard() {
            detectLanguage();
            
            try {
                // Mock for standalone testing if needed, usually fetches from ./discovery
                const configRes = await fetch('./discovery');
                if (!configRes.ok) throw new Error("Failed to fetch config");
                dashboardConfig = await configRes.json();
                
                renderScopeBadge(dashboardConfig.scope);
                buildLayout(dashboardConfig.layout);
                applyTranslations();

                fetchData();
                setInterval(fetchData, 60000);

            } catch (err) {
                // If local testing without backend, show mock error or fallback
                console.warn("Using mock data due to error:", err);
                useMockData(); // Fallback for demonstration
            }
        }

        // Fallback for preview purposes only
        function useMockData() {
            dashboardConfig = {
                scope: "global",
                layout: [
                    { id: "req", type: "metric", title_key: "total_requests", data_key: "total_requests" },
                    { id: "ws", type: "metric", title_key: "total_websockets", data_key: "total_websockets" },
                    { id: "res", type: "chart", title_key: "response_codes", data_key: "response_codes", color_mode: "status_code" },
                    { id: "proto", type: "chart", title_key: "http_protocols", data_key: "http_protocols" },
                    { id: "tls", type: "chart", title_key: "tls_version", data_key: "tls_version" }
                ]
            };
            renderScopeBadge("global");
            buildLayout(dashboardConfig.layout);
            applyTranslations();
            
            // Simulate data fetch
            currentStats = {
                total_requests: 12450,
                total_websockets: 32,
                response_codes: { "200": 11000, "404": 200, "500": 50, "301": 1200 },
                http_protocols: { "HTTP/1.1": 4000, "HTTP/2.0": 8000, "HTTP/3": 450 },
                tls_version: { "TLS 1.2": 2500, "TLS 1.3": 9500, "TLS 1.0": 10 }
            };
            updateDashboardValues();
        }

        async function fetchData() {
            try {
                const res = await fetch('./data');
                if (!res.ok) return;
                currentStats = await res.json();
                updateDashboardValues();
            } catch (e) { console.warn("Fetch data failed", e); }
        }

        // --- UI Construction ---

        function renderScopeBadge(scope) {
            const badge = document.getElementById('scopeBadge');
            badge.style.display = 'inline-block';
            badge.className = `badge ${scope === 'global' ? 'badge-global' : 'badge-instance'}`;
            badge.innerText = scope.charAt(0).toUpperCase() + scope.slice(1);
        }

        function buildLayout(layoutItems) {
            const container = document.getElementById('dashboardContent');
            container.innerHTML = ''; 

            layoutItems.forEach((item, index) => {
                const cardWrapper = document.createElement('div');
                // Use 'col-half' (half width) or 'col-full' (full width)
                cardWrapper.className = `card ${item.grid_width === 'half' ? 'col-half' : 'col-full'}`;
                
                // Add staggered animation delay
                cardWrapper.style.animationDelay = `${index * 0.1}s`;

                if (item.type === 'metric') {
                    cardWrapper.innerHTML = `
                        <div class="metric-group">
                            <div class="metric-value" id="val-${item.id}">0</div>
                            <div class="metric-label" data-i18n="${item.title_key}"></div>
                        </div>
                    `;
                } else if (item.type === 'chart') {
                    cardWrapper.innerHTML = `
                        <div class="card-title" data-i18n="${item.title_key}"></div>
                        <div id="list-${item.id}" class="stats-list">
                            <div class="empty-state" data-i18n="loading"></div>
                        </div>
                    `;
                }
                container.appendChild(cardWrapper);
            });
        }

        function updateDashboardValues() {
            if (!dashboardConfig || !currentStats) return;

            dashboardConfig.layout.forEach(item => {
                const dataValue = currentStats[item.data_key];
                
                if (item.type === 'metric') {
                    animateNumber(`val-${item.id}`, dataValue || 0);
                } else if (item.type === 'chart') {
                    renderChartList(`list-${item.id}`, dataValue, item);
                }
            });
        }

        function renderChartList(containerId, dataMap, configItem) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (!dataMap || Object.keys(dataMap).length === 0) {
                const noDataText = translations[currentLang] ? translations[currentLang].no_data : "No data";
                container.innerHTML = `<div class="empty-state">${noDataText}</div>`;
                return;
            }

            const fragment = document.createDocumentFragment();
            const total = Object.values(dataMap).reduce((a, b) => a + b, 0);
            const keys = Object.keys(dataMap).sort((a, b) => dataMap[b] - dataMap[a]);

            keys.forEach((key, index) => {
                const count = dataMap[key];
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                
                let colorVar;

                // Logic Updated: 
                // We intentionally ignore 'static' color mode to enforce dynamic palette cycling for all non-status-code charts.
                // This ensures new metrics automatically get colorful bars without manual config.

                // Priority 1: Status Code Semantic Coloring
                if (configItem.color_mode === 'status_code') {
                    if (key.startsWith('2')) colorVar = 'var(--color-2xx)';
                    else if (key.startsWith('3')) colorVar = 'var(--color-3xx)';
                    else if (key.startsWith('4')) colorVar = 'var(--color-4xx)';
                    else if (key.startsWith('5')) colorVar = 'var(--color-5xx)';
                    else {
                        // Fallback to palette for non-standard keys in status code chart
                        const paletteColor = colorPalette[index % colorPalette.length];
                        colorVar = `var(${paletteColor})`;
                    }
                } 
                // Priority 2: Dynamic Palette (Default for everything else)
                else {
                    // Cycle through the palette based on index
                    const paletteColor = colorPalette[index % colorPalette.length];
                    colorVar = `var(${paletteColor})`;
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = 'stat-item';
                itemDiv.innerHTML = `
                    <div class="stat-header">
                        <span class="stat-name">${key}</span>
                        <span>${count.toLocaleString()} <span style="opacity:0.5;font-size:0.85em;margin-left:4px">(${percentage}%)</span></span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-bar" style="background-color: ${colorVar}; width: ${percentage}%"></div>
                    </div>
                `;
                fragment.appendChild(itemDiv);
            });

            container.innerHTML = '';
            container.appendChild(fragment);
        }

        function animateNumber(elementId, endValue) {
            const el = document.getElementById(elementId);
            if (!el) return;
            const current = parseInt(el.innerText.replace(/,/g, '')) || 0;
            if (current === endValue) return;

            // Simple ease-out counter
            const duration = 1000;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                // Ease out quart
                const ease = 1 - Math.pow(1 - progress, 4);
                
                const val = Math.floor(current + (endValue - current) * ease);
                el.innerText = val.toLocaleString();

                if (progress < 1) requestAnimationFrame(update);
                else el.innerText = endValue.toLocaleString();
            }
            requestAnimationFrame(update);
        }

        // --- i18n Logic ---

        function detectLanguage() {
            const storedLang = localStorage.getItem('caddy_stats_lang');
            if (storedLang && translations[storedLang]) {
                currentLang = storedLang;
            } else {
                const browserLang = navigator.language || navigator.userLanguage;
                if (browserLang.toLowerCase().includes('zh-cn')) currentLang = 'zh-CN';
                else if (browserLang.toLowerCase().includes('zh-tw') || browserLang.toLowerCase().includes('zh-hk')) currentLang = 'zh-TW';
                else if (browserLang.toLowerCase().includes('ja')) currentLang = 'ja';
                else currentLang = 'en';
            }
            updateLangUI(currentLang);
        }

        function changeLanguage(lang) {
            if (!translations[lang]) return;
            currentLang = lang;
            localStorage.setItem('caddy_stats_lang', lang);
            updateLangUI(lang);
            applyTranslations();
            updateDashboardValues(); 
        }

        function updateLangUI(lang) {
            document.documentElement.lang = lang;
            document.getElementById('currentLangLabel').innerText = langLabels[lang] || lang;
            
            // Highlight selected
            document.querySelectorAll('.lang-option').forEach(opt => {
                opt.classList.remove('selected');
                if(opt.getAttribute('onclick').includes(lang)) opt.classList.add('selected');
            });
        }

        function applyTranslations() {
            const t = translations[currentLang];
            document.title = t.page_title;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.innerText = t[key];
            });
        }

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>